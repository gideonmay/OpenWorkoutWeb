<!DOCTYPE html>
<html lang="en-US">

<head>

<title>${product} - ${name}</title>

<link rel="stylesheet" href="${root_url}/css/normalize.css">
<link rel="stylesheet" href="${root_url}/css/site.css">

<meta charset="UTF-8">
<meta name="description" content="Lists all users following the logged in user">
<meta name="keywords" content="friends">

</head>

<link rel="shortcut icon" href="${root_url}/media/favicon.ico" >

<body>

<script type="text/javascript" src="${root_url}/js/all.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>

<script>
	function follow(target)
	{
		var the_url = "${root_url}/api/1.0/request_to_be_friends";
		var dict = [];
		var result_text = {};

		dict.push({["target_email"] : target.name});
		if (send_post_request(the_url, dict, result_text))
		{
			window.location.replace("${root_url}/friends");
		}
		else
		{
			alert(result_text.value);
		}
	}

	function search()
	{
		var the_url = "${root_url}/api/1.0/list_matched_users";
		var searchname = document.getElementById("searchname").value;
		var dict = [];
		var result_text = {};

		dict.push({["searchname"] : searchname});
		if (send_post_request(the_url, dict, result_text))
		{
			var table = document.getElementById('search_results');
			var obj = JSON.parse(result_text.value);
			for (var i = 0; i < obj.length; i++)
			{
				var tr = document.createElement('tr');   
				var td1 = document.createElement('td');
				var td2 = document.createElement('td');
				var emailText = document.createTextNode(obj[i]);
				var followLink = document.createElement('button');
				var followLinkText = document.createTextNode('Follow');

				followLink.appendChild(followLinkText);
				followLink.title = "Follow";
				followLink.value = obj[i];
				followLink.name = obj[i];
				followLink.addEventListener('click', function() { follow(this); });

				td1.appendChild(emailText);
				td2.appendChild(followLink);
				tr.appendChild(td1);
				tr.appendChild(td2);

				table.appendChild(tr);
			}
		}
		else
		{
			alert(result_text.value);
		}
	}

    function append_to_friends_table(table, row_name, row_value)
    {
        var new_row = table.insertRow();
        var cell = new_row.insertCell();
        var text = document.createTextNode(row_name);
        cell.appendChild(text);

        cell = new_row.insertCell();
        text = document.createTextNode(row_value);
        cell.appendChild(text);
    }

    var process_friends_list = function(records)
    {
		var friends_table = document.getElementById("Friends");
        var sorted_friends_list = Object.keys(records).sort()

        for (var friend of sorted_friends_list)
        {
            append_to_friends_table(friends_table, friend);
        }
    }

    function get_friends_list()
    {
		$.ajax({ type: 'GET', url: "${root_url}/api/1.0/list_friends", cache: false, success: process_friends_list, dataType: "json" });
    }

    get_friends_list();
</script>

<section class="nav">
${nav}
</section>

<div class="user_search_form" style="width: 600px">
	<h2>Search for a user</h2>
	<p>User Email or Name: <input type="text" id="searchname"><br></p>
	<button type="button" onclick="return search()">Search</button>
</div>

<div class="friends_list" style="width: 600px">
	<table id="search_results" >
	</table>
</div>

<div class="friends_list" style="width: 600px">
	<h2>My Friends</h2>
	<table id="Friends">
	</table>
</div>

</body>

</html>
