<!DOCTYPE html>
<html lang="en-US">

<head>

<title>${product} - ${name}</title>

<link rel="stylesheet" href="${root_url}/css/normalize.css">
<link rel="stylesheet" href="${root_url}/css/site.css">

<meta charset="UTF-8">
<meta name="description" content="User settings">
<meta name="keywords" content="settings">

</head>

<link rel="shortcut icon" href="${root_url}/media/favicon.ico" >

<body>

<script type="text/javascript" src="${root_url}/js/all.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>

<script>

	function update_settings()
	{
		var the_url = "${root_url}/api/1.0/update_settings";
		var privacy = document.getElementById("privacy_options").value;
		var units = document.getElementById("units").value;
		var week_start = document.getElementById("week_start").value;
		var dict = [];
		var result_text = {};

		dict.push({["default privacy"] : privacy});
		dict.push({["preferred units"] : units});
		dict.push({["preferred first day of week"] : week_start});
		if (send_post_request(the_url, dict, result_text))
			alert("Settings updated!");
		else
			alert("An error occurred!");
	}

	function update_email()
	{
		var the_url = "${root_url}/api/1.0/update_email";
		var new_email = document.getElementById("new_email").value;
		var dict = [];
		var result_text = {};

		dict.push({["email"] : new_email});
		if (send_post_request(the_url, dict, result_text))
			alert("Email updated!");
		else
			alert("An error occurred!");
	}

	function update_password()
	{
		var the_url = "${root_url}/api/1.0/update_password";
		var current_pword = document.getElementById("current_password").value;
		var new_pword1 = document.getElementById("new_password1").value;
		var new_pword2 = document.getElementById("new_password2").value;
		var dict = [];
		var result_text = {};

		dict.push({["old_password"] : current_pword});
		dict.push({["new_password1"] : new_pword1});
		dict.push({["new_password2"] : new_pword2});
		if (send_post_request(the_url, dict, result_text))
			alert("Password updated!");
		else
			alert("An error occurred!");
	}

    function manage_api_keys()
    {
        window.location.replace("${root_url}/api_keys");
    }

	function delete_gear()
	{
		if (confirm('Are you sure you want to do this?'))
		{
			var the_url = "${root_url}/api/1.0/delete_users_gear";
			var pword = document.getElementById("password").value;

            if (pword.length > 0)
            {
                var dict = [];
                var result_text = {};

                dict.push({["password"] : pword});
                if (send_post_request(the_url, dict, result_text))
                    window.location.replace("${root_url}");
                else
                    alert("An error occurred!");
            }
            else
            {
                alert("Please enter your password.");
            }
		}
	}

	function delete_activities()
	{
		if (confirm('Are you sure you want to do this?'))
		{
			var the_url = "${root_url}/api/1.0/delete_users_activities";
			var pword = document.getElementById("password").value;

            if (pword.length > 0)
            {
                var dict = [];
                var result_text = {};

                dict.push({["password"] : pword});
                if (send_post_request(the_url, dict, result_text))
                    window.location.replace("${root_url}");
                else
                    alert("An error occurred!");
            }
            else
            {
                alert("Please enter your password.");
            }
		}
	}

	function delete_user()
	{
		if (confirm('Are you sure you want to do this?'))
		{
			var the_url = "${root_url}/api/1.0/delete_user";
			var pword = document.getElementById("password").value;

            if (pword.length > 0)
            {
                var dict = [];
                var result_text = {};

                dict.push({["password"] : pword});
                if (send_post_request(the_url, dict, result_text))
                    window.location.replace("${root_url}");
                else
                    alert("An error occurred!");
            }
            else
            {
                alert("Please enter your password.");
            }
		}
	}

    var process_user_settings = function(records)
    {
        for (var record of records)
        {
            var key = Object.keys(record)[0];
            var value = record[key].toLowerCase();

            if (key == "default privacy")
            {
                var element = document.getElementById("privacy_options");

                if (value == "public")
                    element.selectedIndex = 0;
                else
                    element.selectedIndex = 1;
            }
            else if (key == "preferred units")
            {
                var element = document.getElementById("units");

                if (value == "metric")
                    element.selectedIndex = 0;
                else
                    element.selectedIndex = 1;
            }
            else if (key == "preferred first day of week")
            {
                var element = document.getElementById("week_start");

                if (value == "sunday")
                    element.selectedIndex = 0;
                else if (value == "monday")
                    element.selectedIndex = 1;
                else if (value == "tuesday")
                    element.selectedIndex = 2;
                else if (value == "wednesday")
                    element.selectedIndex = 3;
                else if (value == "thursday")
                    element.selectedIndex = 4;
                else if (value == "friday")
                    element.selectedIndex = 5;
                else if (value == "saturday")
                    element.selectedIndex = 6;
            }
        }
    }

    function get_user_settings()
    {
        var api_url = "${root_url}/api/1.0/get_user_settings?requested%20settings=default%20privacy,preferred%20units,preferred%20first%20day%20of%20week";
        $.ajax({ type: 'GET', url: api_url, cache: false, success: process_user_settings, dataType: "json" });
    }

    get_user_settings();

</script>

<section class="nav">
${nav}
</section>

<section>
    <div class="settings" style="width: 600px">
        <!-- Settings -->
        <h2>Settings</h2>
        <p>
            <label for="privacy_options">Default Activity Privacy</label>
            <select id="privacy_options">
                <option value="Public">Public</option>
                <option value="Private">Private</option>
            </select>
        </p>
        <p>
            <label for="units">Preferred Units</label>
            <select id="units">
                <option value="Metric">Metric</option>
                <option value="Standard">Standard</option>
            </select>
        </p>
        <p>
            <label for="week_start">Week Starts On</label>
            <select id="week_start">
                <option value="Sunday">Sunday</option>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
            </select>
        </p>
        <button type="button" onclick="return update_settings()">Update</button>
        <hr>

        <!-- API Keys -->
        <h2>API Keys</h2>
        <button type="button" onclick="return manage_api_keys()" style="color:black">Manage API Keys</button><br>
        <hr>

        <!-- Email -->
        <h2>Email</h2>
        <p>New Email Address: <input type="text" id="new_email"><br></p>
        <button type="button" onclick="return update_email()">Update</button>
        <p><b>Note:</b> Your email address is only used for login authentication.</p>
        <hr>

        <!-- Password -->
        <h2>Password</h2>
        <p>Current Password: <input type="password" id="current_password"><br></p>
        <p>New Password: <input type="password" id="new_password1"><br></p>
        <p>Confirm Password: <input type="password" id="new_password2"><br></p>
        <button type="button" onclick="return update_password()">Update</button>
        <hr>

        <!-- Delete -->
        <h2>Delete</h2>
        <p>Password: <input type="password" id="password"><br></p>
        <button type="button" onclick="return delete_gear()" style="color:red">Delete My Gear</button><br>
        <button type="button" onclick="return delete_activities()" style="color:red">Delete My Activities</button><br>
        <button type="button" onclick="return delete_user()" style="color:red">Delete My Account and All My Data</button><br>
        <p><b>Note:</b> This cannot be undone.</p>
    </div>
</section>

</body>
</html>
