<!DOCTYPE html>
<html lang="en-US">

<head>

<title>${product} - ${name} - Workout</title>

<link rel="stylesheet" href="${root_url}/css/normalize.css">
<link rel="stylesheet" href="${root_url}/css/site.css">

<meta charset="UTF-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta name="description" content="Allows the user to view workout specifics">
<meta name="keywords" content="automated workout plan generation">
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">

</head>

<link rel="shortcut icon" href="${root_url}/media/favicon.ico" >

<body>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" integrity="sha256-wiYwAtNSF3nuWFREDO5vx5cwSmngwE1pGg59NQURCUY=" crossorigin="anonymous" />

<script type="text/javascript" src="${root_url}/js/all.js"></script>
<script type="text/javascript" src="${root_url}/js/graphs.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js" integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js" integrity="sha512-RJJ1NNC88QhN7dwpCY8rm/6OxI+YdQP48DrLGe/eSAd+n+s1PXwQkkpzzAgoJe4cZFW2GALQoxox61gSY2yQfg==" crossorigin="anonymous"></script>
<script type="text/javascript">

    /// @function export_workout_to_zwo
    // Request a ZWO file.
    function export_workout_to_zwo()
    {
        $.ajax({ type: 'GET', url: "${root_url}/api/1.0/export_workout?workout_id=${workout_id}&format=zwo", cache: false, success: function(response) {
            create_local_file(response, "${workout_id}.zwo", "text/plain;charset=utf-8");
        }, dataType: "text" });
    }

    /// @function export_workout_to_ical
    // Request an iCal file.
    function export_workout_to_ical()
    {
        $.ajax({ type: 'GET', url: "${root_url}/api/1.0/export_workout?workout_id=${workout_id}&format=ics", cache: false, success: function(response) {
            create_local_file(response, "${workout_id}.ical", "text/plain;charset=utf-8");
        }, dataType: "text" });
    }

    /// @function change_scheduled_time
    // Shows the date picker and submits a change to the workout date.
    function change_scheduled_time()
    {
        let the_url = "${root_url}/api/1.0/update_workout";
        let scheduled_time = document.getElementById("scheduled_time").value;
        let dict = [];
        let result_text = {};
        let timestamp = Date.parse(scheduled_time) / 1000;

        dict.push({["workout_id"] : "${workout_id}"});
        dict.push({["scheduled time"] : timestamp});
        if (send_post_request(the_url, dict, result_text))
            alert("Scheduled workout time updated!");
        else
            alert("An error occurred!");
    }

    /// @function create_point
    function create_point(current_time, obj)
    {
        let new_point = {};

        new_point["date"] = new Date(Number(current_time * 1000));
        new_point["value"] = next_y(obj);
        return new_point;
    }

    /// @function next_y
    function next_y(pace, power)
    {
        if (pace > 0)
            return pace;
        return power;
    }

    /// @function next_x
    function next_x(current_x, distance, pace, duration)
    {
        if (distance > 0 && pace > 0)
            current_x += (distance / pace) * 60;
        else
            current_x += duration;
        return current_x
    }

    /// @function draw_workout_graph
    function draw_workout_graph(description)
    {
        let scheduled_time = description["scheduled time"];
        let warmup = description["warmup"];
        let cooldown = description["cooldown"];
        let intervals = description["intervals"];
        let current_x = scheduled_time;
        let graph_data = [];

        // Add the warmup.
        let new_point = create_point(current_x, next_y(warmup.pace, warmup.PowerHigh));
        current_x += warmup.Duration;
        graph_data.push(new_point);

        // Add the main set.
        for (let i = 0; i < intervals.length; ++i)
        {
            let interval = intervals[i];
            let num_repeats = interval["repeat"];
            let distance = interval["distance"]; // meters
            let duration = interval["duration"]; // seconds
            let pace = interval["pace"]; // meters per minute
            let power = interval["power"]; // % of threshold power
            let recovery_distance = interval["recovery distance"]; // meters
            let recovery_duration = interval["recovery duration"]; // seconds
            let recovery_pace = interval["recovery pace"];
            let recovery_power = interval["recovery power"]; // % of threshold power

            for (let j = 0; j < num_repeats; ++j)
            {
                // Main
                let y = next_y(pace, power);
                new_point = create_point(current_x, y);
                current_x = next_x(current_x, distance, pace, duration) - 1;
                graph_data.push(new_point);
                new_point = create_point(current_x, y);
                current_x += 1;
                graph_data.push(new_point);

                // Recovery (last interval doesn't get a recovery)
                if (j < num_repeats - 1)
                {
                    y = next_y(recovery_pace, recovery_power * 100.0);
                    new_point = create_point(current_x, y);
                    current_x = next_x(current_x, recovery_distance, recovery_pace, recovery_duration) - 1;
                    graph_data.push(new_point);
                    new_point = create_point(current_x, y);
                    current_x += 1;
                    graph_data.push(new_point);
                }
            }
        }

        // Add the cooldown.
        new_point = create_point(current_x, next_y(cooldown.pace, cooldown.PowerHigh * 100));
        graph_data.push(new_point);
        current_x += cooldown.Duration;
        new_point = create_point(current_x, next_y(cooldown.pace, cooldown.PowerLow * 100));
        graph_data.push(new_point);

        // Draw the graph.
        draw_graph(0, 0, graph_data, "", "", get_graph_color("Intervals"));
    }

    // Called when the workout description is returned.
    var process_workout_description = function(response)
    {
        // Basic sanity check.
        if (response && response.length >= 3)
        {
            let obj_list = JSON.parse(response);
            if (obj_list == null)
                return;

            document.getElementById("type").textContent = obj_list.type;

            // Description
            let desc_elem = document.getElementById("description");
            let description = obj_list["description"];
            description = "<br>" + description.split("\\n").join("<br>");
            desc_elem.innerHTML = description;

            // Scheduled time
            let scheduled_time_elem = document.getElementById("scheduled_time");
            let scheduled_time = obj_list["scheduled time"];
            let n = new Date(scheduled_time * 1000);
            scheduled_time_elem.placeholder = n.toLocaleDateString();

            // Graph
            draw_workout_graph(obj_list)
        }
        else
        {
            alert("An invalid response was received!");
        }
    };

    /// @function get_workout_description
    // Request the URL that allows iCal to subscribe to the workouts calendar.
    function get_workout_description()
    {
        $.ajax({ type: 'GET', url: "${root_url}/api/1.0/export_workout?workout_id=${workout_id}&format=json", cache: false, success: process_workout_description, dataType: "text" });
    };

    $(function()
    {
        $('#scheduled_time').datepicker({
            value: new Date(),
            changeYear: true,
            changeMonth: true
        });
    });

    $(document).ready(function()
    {
        // Things we need when the page is loaded.
        get_workout_description();
    });

</script>

<section class="nav">
${nav}
</section>

<section class="block">

    <div>
        <h2 id="type"></h2>
    </div>

    <div style="margin-left:50px; margin-right:50px;">

        <p id="description"></p>
        <p>
            <br>
            <input type="text" name="scheduled_time" id="scheduled_time"><br>
            <button type="modern_button" onclick="change_scheduled_time()">Update</button>
        </p>

    </div>

</section>

<div id="charts">
</div>

<section class="block">

    <div>
        <button type="modern_button" onclick="export_workout_to_zwo()">Export to ZWO</button><br>
        <button type="modern_button" onclick="export_workout_to_ical()">Export to iCal</button>
    </div>

</section>

</body>

</html>
