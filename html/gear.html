<!DOCTYPE html>
<html lang="en-US">

<head>

<title>${product} - ${name} - Gear</title>

<link rel="stylesheet" href="${root_url}/css/normalize.css">
<link rel="stylesheet" href="${root_url}/css/site.css">

<meta charset="UTF-8">
<meta name="description" content="Lists all gear belonging to the logged in user">
<meta name="keywords" content="gear list">

</head>

<link rel="shortcut icon" href="${root_url}/media/favicon.ico" >

<body>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" integrity="sha256-wiYwAtNSF3nuWFREDO5vx5cwSmngwE1pGg59NQURCUY=" crossorigin="anonymous" />

<script type="text/javascript" src="${root_url}/js/all.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.js" integrity="sha256-FaYRflg3IJpVUN+JgijEHFUYgsn1wS1xRlcKTIgToIo=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.css" integrity="sha256-zDI1g6Yzr25YWykCOmTUeageF3RWaLnx+Ik8NqVk1xA=" crossorigin="anonymous" />

<script>
	function create_gear(target, gearType)
	{
		var the_url = "${root_url}/api/1.0/create_gear";
		var dict = [];
		var result_text = {};
		var innerDiv = document.getElementById("new_gear_div");
		var addTimeObj = new Date(document.getElementById("startDate").value);
		var addTime = addTimeObj.getTime() / 1000;
		var retiredTimeObj = new Date(document.getElementById("retiredDate").value);
		var retiredTime = retiredTimeObj.getTime() / 1000;
		var name = document.getElementById("Name").value;
		var description = document.getElementById("Description").value;

		dict.push({["type"] : gearType});
		dict.push({["add_time"] : addTime});
		dict.push({["retire_time"] : retiredTime});
		dict.push({["name"] : name});
		dict.push({["description"] : description});

		if (send_post_request(the_url, dict, result_text))
		{
			window.location.replace("${root_url}/gear");
		}
		else
		{
			alert(result_text.value);
		}
	}

    function get_new_gear_info(gearType)
    {
		var outerDiv = document.getElementById("block");
		var innerDiv = document.createElement('div');
		innerDiv.id = "new_gear_div";

		// Remove existing items, if any.
		while (outerDiv.firstChild)
		{
			outerDiv.removeChild(outerDiv.firstChild);
		}

		// Determine which data fields are needed.
		var fields = ["Name", "Description"];

		// Add a label for the date picker.
		var dateLabel = document.createTextNode("Date Added: ");
		innerDiv.appendChild(dateLabel);

		// Add the date picker.
		var today = new Date();
		var startDate = document.createElement('input');
		startDate.type = "input";
		startDate.id = "startDate";
		startDate.className = "pickDate";
		$(startDate).datepicker({showButtonPanel: true, defaultDate: today});
		$(startDate).datepicker('setDate', today);
		innerDiv.appendChild(startDate);

		// Add a line break.
		var br = document.createElement("br");
		innerDiv.appendChild(br);

		// Add a label for the date retired picker.
		var dateLabel = document.createTextNode("Date Retired: ");
		innerDiv.appendChild(dateLabel);

		// Add the date retired picker.
		var retiredDate = document.createElement('input');
		retiredDate.type = "input";
		retiredDate.id = "retiredDate";
		retiredDate.className = "pickDate";
		$(retiredDate).datepicker({showButtonPanel: true});
		innerDiv.appendChild(retiredDate);

		// Add a line break.
		br = document.createElement("br");
		innerDiv.appendChild(br);

		// Add the data fields.
		for (i = 0, len = fields.length; i < len; i++)
		{
			add_text_entry_node(innerDiv, fields[i]);
		}

		// Add to the div.
		outerDiv.appendChild(innerDiv);

		// Create a save button.
		var saveBtn = document.createElement('button');
		var saveBtnText = document.createTextNode('Save');
		saveBtn.appendChild(saveBtnText);
		saveBtn.title = "Save";
		saveBtn.addEventListener('click', function() { create_gear(this, gearType); });

		// Add the save button to the screen.
		outerDiv.appendChild(saveBtn);
	}

    function get_new_bike_info()
    {
        get_new_gear_info("bike");
    }

    function get_new_shoes_info()
    {
        get_new_gear_info("shoes");
    }

    function delete_gear(gear_id)
    {
		if (confirm('Are you sure you want to do this?'))
		{
            var the_url = "${root_url}/api/1.0/delete_gear";
            var dict = [];
            var result_text = {};

            dict.push({["gear_id"] : gear_id});

            if (send_post_request(the_url, dict, result_text))
            {
                window.location.replace("${root_url}/gear");
            }
            else
            {
                alert(result_text.value);
            }
        }
    }

    function append_to_table(table, name, gear_id, description, add_time, retire_time)
    {
        var new_row = table.insertRow();
        var cell = new_row.insertCell();
        var a = document.createElement('a');
        var link_text = document.createTextNode(name);
        a.appendChild(link_text);
        a.title = name;
        a.href = "${root_url}/service_history/" + gear_id;
        cell.appendChild(a);

        cell = new_row.insertCell();
        text = document.createTextNode(description);
        cell.appendChild(text);

        cell = new_row.insertCell();
        if (add_time > 0)
            text = document.createTextNode(unix_time_to_local_date_string(add_time));
        else
            text = document.createTextNode("");
        cell.appendChild(text);

        cell = new_row.insertCell();
        if (retire_time > 0)
            text = document.createTextNode(unix_time_to_local_date_string(retire_time));
        else
            text = document.createTextNode("");
        cell.appendChild(text);

        var btn = document.createElement('button');
        var btn_txt = document.createTextNode('Delete');
        btn.appendChild(btn_txt);
        btn.title = "Delete";
        btn.addEventListener('click', function() { delete_gear(gear_id); });
        cell = new_row.insertCell();
        cell.appendChild(btn);
    }

    var process_gear = function(records)
    {
		var bikes_table = document.getElementById("Bikes");
		var shoes_table = document.getElementById("Shoes");

        for (var record of records)
        {
            if (record.type == "bike")
            {
                append_to_table(bikes_table, record.name, record.gear_id, record.description, record.add_time, record.retire_time);
            }
            else if (record.type == "shoes")
            {
                append_to_table(shoes_table, record.name, record.gear_id, record.description, record.add_time, record.retire_time);
            }
        }
    }

    function get_gear()
    {
		$.ajax({ type: 'GET', url: "${root_url}/api/1.0/list_gear", cache: false, success: process_gear, dataType: "json" });
    }

    get_gear();
</script>

<section class="nav">
${nav}
</section>

<div class="block" id="block" style="width: 600px">

    <h2>Bikes</h2>
    <p>
        <table id="Bikes">
            <td><b>Name</b></td><td><b>Description</b></td><td><b>Date Added</b><td><b>Date Retired</b></td><tr>
        </table>
    </p>
    <button type="button" onclick="return get_new_bike_info()">Add New Bike</button>

	<hr>

    <h2>Shoes</h2>
    <p>
        <table id="Shoes">
            <td><b>Name</b></td><td><b>Description</b></td><td><b>Date Added</b><td><b>Date Retired</b></td><tr>
        </table>
    </p>
    <button type="button" onclick="return get_new_shoes_info()">Add New Shoes</button>

</div>

</body>

</html>
