<!DOCTYPE html>
<html lang="en-US">

<head>

<title>${product} - ${name}</title>

<link rel="stylesheet" href="${root_url}/css/normalize.css">
<link rel="stylesheet" href="${root_url}/css/site.css">

<meta charset="UTF-8">
<meta name="description" content="Allows the user to import existing workout files">
<meta name="keywords" content="import">

</head>

<link rel="shortcut icon" href="${root_url}/media/favicon.ico" >

<body>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" integrity="sha256-wiYwAtNSF3nuWFREDO5vx5cwSmngwE1pGg59NQURCUY=" crossorigin="anonymous" />

<script type="text/javascript" src="${root_url}/js/all.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>

<script type="text/javascript" src="${root_url}/jquery-timepicker/jquery.timepicker.js"></script>
<link rel="stylesheet" type="text/css" href="${root_url}/jquery-timepicker/jquery.timepicker.css" />

<script>

	function save(target)
	{
		var the_url = "${root_url}/api/1.0/add_activity";
		var dict = [];
		var sets = [];
		var result_text = {};
		var inner_div = document.getElementById("manual_entry_div");
		var startDate = document.getElementById("startDate").value;
		var startTime = document.getElementById("startTime").value;
		var activityStartObj = new Date(startDate + " " + startTime);
		var activityStart = activityStartObj.getTime() / 1000;
		var activityType = document.getElementById("activity_type").value;

		for (var i = 0; i < inner_div.children.length; i++)
		{
			var divChild = inner_div.children[i];

			if (divChild.name == "Repititions")
			{
				sets.push(parseInt(divChild.value));
			}
			else if ((divChild.name == "Duration") || (divChild.name == "Distance"))
			{
				dict.push({[divChild.name] : parseFloat(divChild.value)});
			}
		}
		dict.push({["Sets"] : JSON.stringify(sets)});
		dict.push({["time"] : activityStart});
		dict.push({["activity_type"] : activityType});

		if (send_post_request(the_url, dict, result_text))
		{
			window.location.replace("${root_url}/task_status");
		}
		else
		{
			alert(result_text.value);
		}
	}

	function show_manual_entry_options()
	{
		var activityType = document.getElementById("activity_type").value;
		var outer_div = document.getElementById("block");
		var inner_div = document.createElement('div');
		inner_div.id = "manual_entry_div";

		// Remove existing items, if any.
		while (outer_div.firstChild)
		{
			outer_div.removeChild(outer_div.firstChild);
		}

		// Determine which data fields are needed.
		var fields = ["Duration", "Distance"];
		switch (activityType)
		{
			case "Push Up":
			case "Pull Up":
				fields = ["Repititions", "Repititions", "Repititions"];
				break;
		}

		// Add a label for the date picker.
		var dateLabel = document.createTextNode("Date: ");
		inner_div.appendChild(dateLabel);

		// Add the date picker.
		var today = new Date();
		var startDate = document.createElement('input');
		startDate.type = "input";
		startDate.id = "startDate";
		startDate.className = "pickDate";
		$(startDate).datepicker({showButtonPanel: true, defaultDate: today});
		$(startDate).datepicker('setDate', today);
		inner_div.appendChild(startDate);

		// Add a label for the start time picker.
		var dateLabel = document.createTextNode("Start Time: ");
		inner_div.appendChild(dateLabel);

		// Add the start time picker.
		var startTime = document.createElement('input');
		startTime.type = "input";
		startTime.id = "startTime";
		startTime.className = "pickTime"; 
		$(startTime).timepicker({ 'timeFormat': 'h:i A' });
		inner_div.appendChild(startTime);

		// Add a line break.
		var br = document.createElement("br");
		inner_div.appendChild(br);

		// Add the data fields.
		for (i = 0, len = fields.length; i < len; i++)
		{
			add_number_entry_node(inner_div, fields[i]);
		}

		// Add to the div.
		outer_div.appendChild(inner_div);

		// Create a save button.
		var save_btn = document.createElement('button');
		save_btn.appendChild(document.createTextNode('Save'));
		save_btn.title = "Save";
		save_btn.addEventListener('click', function() { save(this); });

		// Add the save button to the screen.
		outer_div.appendChild(save_btn);

		return false;
	}
</script>

<section class="nav">
${nav}
</section>

<div class="import" style="width: 600px">
	<h2>Import File(s)</h2>

	<input type="file" id="picker" name="file_list" webkitdirectory multiple><br>
    <table class="import" id="upload_table">
    </table>
	<button type="button" onclick="return upload_dir()">Upload</button><br>

	<script>
		let picker = document.getElementById('picker');
		let file_list = [];
        let file_tasks = {};

        function update_file_status(file_name, status_text)
        {
            let upload_table = document.getElementById("upload_table");

            for (var i = 0, row; row = upload_table.rows[i]; i++)
            {
                if (row.cells[0].innerText.localeCompare(file_name) == 0)
                {
                    row.cells[1].innerText = status_text;
                    break;
                }
            }
        }

        function monitor_file_status(file_name, task_id)
        {
            file_tasks[task_id] = file_name;
        }

        function upload_file_no_ui(file_obj)
        {
            var reader = new FileReader();

            reader.onerror = function(event)
            {
                reader.abort();
            };
            reader.onload = function(e)
            {
                var the_url = "${root_url}/api/1.0/upload_activity_file";
                var dict = [];
                var result_text = {};
                var encoded_data = btoa(reader.result);

                dict.push({["uploaded_file_name"] : file_obj.name});
                dict.push({["uploaded_file_data"] : encoded_data});

                if (send_post_request(the_url, dict, result_text))
                {
                    update_file_status(file_obj.name, "Uploaded (Queued For Processing)");
                    monitor_file_status(file_obj.name, result_text.value);
                }
                else
                {
                    alert(result_text.value);
                }
            }
            reader.readAsBinaryString(file_obj);
        }

		function upload_dir()
		{
            if (file_list.length > 0)
            {
                for (var i = 0; i < file_list.length; i++)
                {
                    upload_file_no_ui(file_list[i]);
                }
            }
            else
            {
                alert("No files have been specified.");
            }
		}

		picker.addEventListener('change', e => {
            let upload_table = document.getElementById("upload_table");

			for (let file of Array.from(e.target.files))
			{
                let new_row = upload_table.insertRow();
                let cell = new_row.insertCell();
                let text = document.createTextNode(file.name);
                cell.appendChild(text);
                cell = new_row.insertCell();
                text = document.createTextNode("Waiting");
                cell.appendChild(text);

				file_list.push(file);
			};
		});

        var process_task_statuses = function(records)
        {
            for (var record of records)
            {
                if (record['internal task id'] in file_tasks)
                {
                    update_file_status(record["task details"], record["task status"]);
                }
            }
        }

        var check_for_updates = function()
        {
            $.ajax({ type: 'GET', url: "${root_url}/api/1.0/get_task_statuses", cache: false, success: process_task_statuses, dataType: "json" });
        }

        setInterval(check_for_updates, 5000);
	</script>

	<hr>

	<h2>Manual Entry</h2>

	<form onChange="return show_manual_entry_options()" method="post" enctype="multipart/form-data">
		<select id="activity_type" name="activity_type">
${activity_type_list}
		</select>
	</form>
</div>
	
<div class="block" id="block">
</div>

</body>
</html>
