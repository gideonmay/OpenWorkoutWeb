<!DOCTYPE html>
<html lang="en-US">

<head>

<title>${product} - ${name}</title>

<link rel="stylesheet" href="${root_url}/css/normalize.css">
<link rel="stylesheet" href="${root_url}/css/site.css">

<meta charset="UTF-8">
<meta name="description" content="Allows the user to import existing workout files">
<meta name="keywords" content="import">

</head>

<link rel="shortcut icon" href="${root_url}/media/favicon.ico" >

<body>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" integrity="sha256-wiYwAtNSF3nuWFREDO5vx5cwSmngwE1pGg59NQURCUY=" crossorigin="anonymous" />
<link rel="stylesheet" type="text/css" href="${root_url}/jquery-timepicker/jquery.timepicker.css" />

<script type="text/javascript" src="${root_url}/js/all.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>
<script type="text/javascript" src="${root_url}/jquery-timepicker/jquery.timepicker.js"></script>
<script>

    function save(target)
    {
        var the_url = "${root_url}/api/1.0/add_activity";
        var dict = [];
        var sets = [];
        var result_text = {};
        var inner_div = document.getElementById("manual_entry_div");
        var startDate = document.getElementById("startDate").value;
        var startTime = document.getElementById("startTime").value;
        var activityStartObj = new Date(startDate + " " + startTime);
        var activityStart = activityStartObj.getTime() / 1000;
        var activityType = document.getElementById("activity_type").value;

        for (var i = 0; i < inner_div.children.length; i++)
        {
            var divChild = inner_div.children[i];

            if (divChild.name == "Repetitions")
            {
                sets.push(parseInt(divChild.value));
            }
            else if ((divChild.name == "Duration") || (divChild.name == "Distance"))
            {
                dict.push({[divChild.name] : parseFloat(divChild.value)});
            }
        }
        dict.push({["Sets"] : JSON.stringify(sets)});
        dict.push({["time"] : activityStart});
        dict.push({["activity_type"] : activityType});

        if (send_post_request(the_url, dict, result_text))
        {
            window.location.replace("${root_url}/task_status");
        }
        else
        {
            alert(result_text.value);
        }
    }

    function show_manual_entry_options()
    {
        var activityType = document.getElementById("activity_type").value;
        var outer_div = document.getElementById("manual_entry_div");
        var inner_div = document.createElement('div');
        inner_div.id = "manual_entry_div";

        // Remove existing items, if any.
        while (outer_div.firstChild)
        {
            outer_div.removeChild(outer_div.firstChild);
        }

        // Determine which data fields are needed.
        var fields = ["Duration", "Distance"];
        switch (activityType)
        {
            case "Push Up":
            case "Pull Up":
                fields = ["Repetitions", "Repetitions", "Repetitions"];
                break;
        }

        // Add a label for the date picker.
        var dateLabel = document.createTextNode("Date: ");
        inner_div.appendChild(dateLabel);

        // Add the date picker.
        var today = new Date();
        var startDate = document.createElement('input');
        startDate.type = "input";
        startDate.id = "startDate";
        startDate.className = "pickDate";
        $(startDate).datepicker({showButtonPanel: true, defaultDate: today});
        $(startDate).datepicker('setDate', today);
        inner_div.appendChild(startDate);

        // Add a label for the start time picker.
        var dateLabel = document.createTextNode("Start Time: ");
        inner_div.appendChild(dateLabel);

        // Add the start time picker.
        var startTime = document.createElement('input');
        startTime.type = "input";
        startTime.id = "startTime";
        startTime.className = "pickTime"; 
        $(startTime).timepicker({ 'timeFormat': 'h:i A' });
        inner_div.appendChild(startTime);

        // Add a line break.
        var br = document.createElement("br");
        inner_div.appendChild(br);

        // Add the data fields.
        for (i = 0, len = fields.length; i < len; i++)
        {
            add_number_entry_node(inner_div, fields[i]);
        }

        // Add to the div.
        outer_div.appendChild(inner_div);

        // Create a save button.
        var save_btn = document.createElement('button');
        save_btn.appendChild(document.createTextNode('Save'));
        save_btn.title = "Save";
        save_btn.addEventListener('click', function() { save(this); });

        // Add the save button to the screen.
        outer_div.appendChild(save_btn);

        return false;
    }

</script>

<section class="nav">
${nav}
</section>

<div class="import" style="width: 600px">
    <h2>Import File(s)</h2>

    <p>Accepted file types are .gpx, .tcx, and .fit formatted files.</p>
    <input type="file" id="picker" name="file_list" class="modern_button" accept=".gpx,.tcx,.fit,.csv" webkitdirectory multiple><br>
    <table class="import" id="upload_table" style="display: none;"></table>
    <table class="import" id="parsed_csv_table" style="display: none;"></table>
    <button type="button" onclick="return upload_selected_files()">Upload File(s)</button><br>

    <script>
        let picker = document.getElementById('picker');
        let file_list = [];
        let file_tasks = {}; // Associates the task ID returned by the server with the file being uploaded

        /// @function update_file_status
        function update_file_status(file_name, status_text, activity_id)
        {
            let upload_table = document.getElementById("upload_table");
            upload_table.style = "display: inline-block;";

            for (let i = 0, row; row = upload_table.rows[i]; i++)
            {
                if (row.cells[0].innerText.localeCompare(file_name) == 0)
                {
                    if (status_text == "Finished")
                    {
                        row.cells[0].innerText = "";
                        let link = document.createElement("a");
                        let linkText = document.createTextNode(file_name);
                        link.setAttribute("href", "${root_url}/activity/" + activity_id);
                        link.appendChild(linkText);
                        row.cells[0].appendChild(link);
                    }
                    row.cells[1].innerText = status_text;
                    break;
                }
            }
        }

        /// @function monitor_file_status
        function monitor_file_status(file_name, task_id)
        {
            file_tasks[task_id] = file_name;
        }

        /// @function add_select_option
        function add_select_option(select, option_text)
        {
            let option = document.createElement("option");

            option.value = option_text;
            option.text = option_text;
            select.appendChild(option);
        }

        /// @function parse_csv_file
        function parse_csv_file(file_obj)
        {
            let reader = new FileReader();

            reader.onerror = function(event)
            {
                reader.abort();
            };
            reader.onload = function(e)
            {
                let line_data = reader.result.split("\n");
                let csv_table = document.getElementById("parsed_csv_table");
                let title_row = csv_table.insertRow();
                let is_first_row = true;

                csv_table.style = "display: inline-block;";

                line_data.forEach(res => {
                    let column_data = res.split(",");
                    let new_row = csv_table.insertRow();

                    if (is_first_row) {
                        column_data.forEach(column => {
                            let cell = title_row.insertCell();
                            let select = document.createElement("select");

                            add_select_option(select, "---");
                            add_select_option(select, "Date");
                            for (let i = 1; i <= column_data.length; ++i)
                            {
                                add_select_option(select, "Set " + i.toString());
                            }
                            cell.appendChild(select);
                        });
                        is_first_row = false;
                    }

                    column_data.forEach(column => {
                        let cell = new_row.insertCell();
                        let text = document.createTextNode(column);

                        cell.appendChild(text);
                    });
                });
            }
            reader.readAsBinaryString(file_obj);
        }
    
        /// @function upload_file
        function upload_file(file_obj)
        {
            let reader = new FileReader();

            reader.onerror = function(event)
            {
                reader.abort();
            };
            reader.onload = function(e)
            {
                let the_url = "${root_url}/api/1.0/upload_activity_file";
                let dict = [];
                let result_text = {};
                let encoded_data = btoa(reader.result);

                dict.push({["uploaded_file_name"] : file_obj.name});
                dict.push({["uploaded_file_data"] : encoded_data});

                if (send_post_request(the_url, dict, result_text))
                {
                    update_file_status(file_obj.name, "Uploaded (Queued For Processing)", null);
                    monitor_file_status(file_obj.name, result_text.value);
                }
                else
                {
                    alert(result_text.value);
                }
            }
            reader.readAsBinaryString(file_obj);
        }

        /// @function upload_selected_files
        function upload_selected_files()
        {
            if (file_list.length > 0)
            {
                for (let i = 0; i < file_list.length; i++)
                {
                    let file_obj = file_list[i];
                    let file_name = file_obj.name;
                    let file_ext = file_name.substr(file_name.lastIndexOf('.') + 1);

                    if (file_ext == "csv")
                        parse_csv_file(file_obj);
                    else
                        upload_file(file_obj);
                }
            }
            else
            {
                alert("No files have been specified.");
            }
        }

        picker.addEventListener('change', e => {
            let upload_table = document.getElementById("upload_table");

            for (let file of Array.from(e.target.files))
            {
                let new_row = upload_table.insertRow();
                let cell = new_row.insertCell();
                let text = document.createTextNode(file.name);

                cell.appendChild(text);
                cell = new_row.insertCell();
                text = document.createTextNode("Waiting");
                cell.appendChild(text);

                file_list.push(file);
            };
        });

        var process_task_statuses = function(records)
        {
            for (let record of records)
            {
                if (record['internal task id'] in file_tasks)
                {
                    if ("activity id" in record)
                        activity_id = record["activity id"];
                    else
                        activity_id = null;
                    update_file_status(record["task details"], record["task status"], activity_id);
                }
            }
        }

        var check_for_updates = function()
        {
            $.ajax({ type: 'GET', url: "${root_url}/api/1.0/get_task_statuses", cache: false, success: process_task_statuses, dataType: "json" });
        }

        setInterval(check_for_updates, 5000);
    </script>
</div>
    
<div class="block" id="manual_entry_div">
</div>

</body>
</html>
