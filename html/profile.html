<!DOCTYPE html>
<html lang="en-US">

<head>

<title>${product} - ${name}</title>

<link rel="stylesheet" href="${root_url}/css/normalize.css">
<link rel="stylesheet" href="${root_url}/css/site.css">

<meta charset="UTF-8">
<meta name="description" content="User profile">
<meta name="keywords" content="profile">

</head>

<link rel="shortcut icon" href="${root_url}/media/favicon.ico" >

<body>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" integrity="sha256-wiYwAtNSF3nuWFREDO5vx5cwSmngwE1pGg59NQURCUY=" crossorigin="anonymous" />

<script type="text/javascript" src="${root_url}/js/all.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>

<script>

    function update_gear_defaults(target)
    {
        var the_url = "${root_url}/api/1.0/update_gear_defaults";
        var dict = [];
        var result_text = {};
        var inner_div = document.getElementById("new_gear_default_div");
        var activity_type = document.getElementById("activity_type").value;
        var gear = document.getElementById("gear").value;

        dict.push({["activity_type"] : activity_type});
        dict.push({["name"] : gear});

        if (send_post_request(the_url, dict, result_text))
        {
            window.location.replace("${root_url}/profile");
        }
        else
        {
            alert(result_text.value);
        }
    }

    var process_activity_type_list = function(activity_type_list)
    {
        activity_type_list = eval(activity_type_list);
        activity_type_list.sort();

        var activity_type_select = document.getElementById("activity_type");
        for (var i = 0; i < activity_type_list.length; i++)
        {
            var activity_type = activity_type_list[i];
            var option = document.createElement("option");
            option.value = activity_type;
            option.text = activity_type;
            activity_type_select.appendChild(option);
        }
    }

    var process_gear_list = function(gear_list)
    {
        gear_list = eval(gear_list);
        gear_list.sort();

        var gear_list_select = document.getElementById("gear");
        for (var i = 0; i < gear_list.length; i++)
        {
            var gear = gear_list[i];
            var option = document.createElement("option");
            option.value = gear.name;
            option.text = gear.name;
            gear_list_select.appendChild(option);
        }
    }

    function list_activity_types()
    {
        var api_url = "${root_url}/api/1.0/list_activity_types";
        $.ajax({ type: 'GET', url: api_url, cache: false, success: process_activity_type_list, dataType: "text" });
    }

    function list_gear()
    {
        var api_url = "${root_url}/api/1.0/list_gear";
        $.ajax({ type: 'GET', url: api_url, cache: false, success: process_gear_list, dataType: "text" });
    }

    function add_default_gear_info()
    {
        var outer_div = document.getElementById("new_gear_default_block");
        var inner_div = document.createElement('div');
        inner_div.id = "new_gear_default_div";

        // Remove existing items, if any.
        while (outer_div.firstChild)
        {
            outer_div.removeChild(outer_div.firstChild);
        }

        // Add a line break.
        outer_div.appendChild(document.createElement("hr"));
        inner_div.appendChild(document.createElement("br"));

        // Add the activity type selector.
        type_select = document.createElement("select");
        type_select.id = "activity_type";
        inner_div.appendChild(type_select);

        // Add the activity type selector.
        gear_select = document.createElement("select");
        gear_select.id = "gear";
        inner_div.appendChild(gear_select);

        // Add a line break.
        inner_div.appendChild(document.createElement("br"));

        // Add to the div.
        outer_div.appendChild(inner_div);

        // Create a save button.
        var save_btn = document.createElement('button');
        save_btn.appendChild(document.createTextNode('Save'));
        save_btn.title = "Save";
        save_btn.addEventListener('click', function() { update_gear_defaults(this); });

        // Add the save button to the screen.
        outer_div.appendChild(save_btn);

        // Add a line break.
        outer_div.appendChild(document.createElement("hr"));

        // Add activity types.
        list_activity_types();

        // Add gear to the gear list.
        list_gear();

        return false;
    }

    function update_birthday()
    {
		var the_url = "${root_url}/api/1.0/update_profile";
		var birthday = document.getElementById("birthday").value;
		var dict = [];
		var result_text = {};
		var timestamp = Date.parse(birthday) / 1000;

		dict.push({["birthday"] : timestamp});
		if (send_post_request(the_url, dict, result_text))
			alert("Birthday updated!");
		else
			alert("An error occurred!");
    }

	function update_height()
	{
		var the_url = "${root_url}/api/1.0/update_profile";
		var height = document.getElementById("height").value;
		var dict = [];
		var result_text = {};

		dict.push({["height"] : height});
		if (send_post_request(the_url, dict, result_text))
			alert("Height updated!");
		else
			alert("An error occurred!");
	}

	function update_weight()
	{
		var the_url = "${root_url}/api/1.0/update_profile";
		var weight = document.getElementById("weight").value;
		var dict = [];
		var result_text = {};

		dict.push({["weight"] : weight});
		if (send_post_request(the_url, dict, result_text))
			alert("Weight updated!");
		else
			alert("An error occurred!");
	}

	function update_gender()
	{
		var the_url = "${root_url}/api/1.0/update_profile";
		var gender = document.getElementById("gender").value;
		var dict = [];
		var result_text = {};

		dict.push({["gender"] : gender});
		if (send_post_request(the_url, dict, result_text))
			alert("Gender updated!");
		else
			alert("An error occurred!");
	}

	function update_resting_hr()
	{
		var the_url = "${root_url}/api/1.0/update_profile";
		var weight = document.getElementById("resting_hr").value;
		var dict = [];
		var result_text = {};

		dict.push({["resting heart rate"] : weight});
		if (send_post_request(the_url, dict, result_text))
			alert("Resting heart rate updated!");
		else
			alert("An error occurred!");
	}

	$(function()
	{
		$('#birthday').datepicker({
            yearRange: '1910:2010',
            changeYear: true,
            changeMonth: true
        });
		var n = new Date(${birthday} * 1000);
		document.getElementsByName('birthday')[0].placeholder=n.toLocaleDateString();
	});

    function append_to_pr_table(table, row_name, row_value)
    {
        var new_row = table.insertRow();
        var cell = new_row.insertCell();
        var text = document.createTextNode(row_name);
        cell.appendChild(text);

        if (row_value.length > 0)
        {
            cell = new_row.insertCell();
            var a = document.createElement('a');
            a.appendChild(document.createTextNode(row_value[0]));
            a.title = row_value;
            a.href = "${root_url}/activity/" + row_value[1];
            cell.appendChild(a);
        }
    }

    var process_personal_records = function(records)
    {
        var cycling_table = document.getElementById("Cycling");
        var running_table = document.getElementById("Running");

        var sorted_cycling_keys = Object.keys(records.Cycling).sort()
        var sorted_running_keys = Object.keys(records.Running).sort()

        if (sorted_cycling_keys.length > 0)
        {
            for (var key of sorted_cycling_keys)
            {
                append_to_pr_table(cycling_table, key, records.Cycling[key]);
            }
        }
        else
        {
            append_to_pr_table(cycling_table, "None", "");
        }

        if (sorted_running_keys.length > 0)
        {
            run_prs = {}
            for (var key of sorted_running_keys)
            {
                if (key.includes("Best 5K"))
                    run_prs[key] = records.Running[key][2];
                append_to_pr_table(running_table, key, records.Running[key]);
            }
        }
        else
        {
            append_to_pr_table(running_table, "None", "");
        }
    }

    function append_to_defaults_table(table, default_info)
    {
        var new_row = table.insertRow();
        var cell = new_row.insertCell();
        cell.appendChild(document.createTextNode(default_info.activity_type));
        cell = new_row.insertCell();
        cell.appendChild(document.createTextNode(default_info.name));
    }

    var process_gear_defaults = function(records)
    {
        var defaults_table = document.getElementById("Defaults");

        for (var record of records)
        {
            append_to_defaults_table(defaults_table, record);
        }
    }

    function get_personal_records()
    {
        var api_url = "${root_url}/api/1.0/list_personal_records";
        $.ajax({ type: 'GET', url: api_url, cache: false, success: process_personal_records, dataType: "json" });
    }

    function get_gear_defaults()
    {
        var api_url = "${root_url}/api/1.0/list_gear_defaults";
        $.ajax({ type: 'GET', url: api_url, cache: false, success: process_gear_defaults, dataType: "json" });
    }

    get_personal_records();
    get_gear_defaults();
</script>

<section class="nav">
${nav}
</section>

<div class="profile" style="width: 600px">
	<h2>Birthday</h2>
	<input type="text" name="birthday" id="birthday"><br>
	<button type="button" onclick="return update_birthday()">Update</button>
	<hr>
	<h2>Height</h2>
	<input type="text" id="height" value="${height}"> ${height_units}<br>
	<button type="button" onclick="return update_height()">Update</button>
	<hr>
	<h2>Weight</h2>
	<input type="text" id="weight" value="${weight}"> ${weight_units}<br>
	<button type="button" onclick="return update_weight()">Update</button>
	<hr>
	<h2>Gender</h2><br>
	<select id="gender" class="checkin" >
${gender_options}
	</select><br>
	<button type="button" onclick="return update_gender()">Update</button>
	<hr>
	<h2>Resting Heart Rate</h2>
	<input type="text" id="resting_hr" value="${resting_hr}"> bpm<br>
	<button type="button" onclick="return update_resting_hr()">Update</button>
	<hr>
	<h2>BMI</h2>
    <p>
        Your Body Mass Index is your weight relative to your height.
    </p>
${bmi}
	<hr>
	<h2>VO2 Max</h2>
${vo2max}
	<hr>
	<h2>Estimated Functional Threshold Power (FTP)</h2>
    <p>
        Functional Threshold Power is the amount of power that you can exert over one hour at maximum effort. It is estimated from recent activity.
    </p>
${ftp}
	<hr>
	<h2>Heart Rate Zones</h2>
${hr_zones}
	<hr>
	<h2>Power Training Zones</h2>
${power_zones}
	<hr>
	<h2>Personal Records</h2>
    <h3>Cycling</h3>
    <table id="Cycling">
    </table>
    <h3>Running</h3>
    <table id="Running">
    </table>
	<hr>
    <h2>Default Gear</h2>
    <table id="Defaults">
    </table>
    <div class="block" id="new_gear_default_block" style="width: 560px">
    </div>
	<button type="button" onclick="return add_default_gear_info()">Add Default</button>
</div>

</body>
</html>
